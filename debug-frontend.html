<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Frontend - CVGen</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>üîß Debug Frontend - CVGen API</h1>
    
    <div class="debug-section">
        <h2>1. Teste de Conex√£o com API</h2>
        <button onclick="testConnection()">Testar Conex√£o</button>
        <div id="connectionResult"></div>
    </div>

    <div class="debug-section">
        <h2>2. Login Admin</h2>
        <input type="email" id="loginEmail" value="admin@bluevisiontech.com" placeholder="Email">
        <input type="password" id="loginPassword" value="password" placeholder="Senha">
        <button onclick="testLogin()">Fazer Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="debug-section">
        <h2>3. Verificar Token no LocalStorage</h2>
        <button onclick="checkToken()">Verificar Token</button>
        <div id="tokenResult"></div>
    </div>

    <div class="debug-section">
        <h2>4. Testar Cria√ß√£o de CV</h2>
        <button onclick="testCreateCV()">Criar CV de Teste</button>
        <div id="cvResult"></div>
    </div>

    <div class="debug-section">
        <h2>5. Logs do Console</h2>
        <div id="consoleLog"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentToken = null;

        // Fun√ß√£o para log
        function log(message, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        // 1. Teste de conex√£o
        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            try {
                log('Testando conex√£o com API...');
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'sucesso') {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Conex√£o OK: ${data.message}</div>`;
                    log('‚úÖ API conectada com sucesso', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro na API: ${data.message}</div>`;
                    log('‚ùå Erro na resposta da API', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
            }
        }

        // 2. Teste de login
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                log('Fazendo login...');
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.status === 'sucesso') {
                    currentToken = data.data.token;
                    localStorage.setItem('cvgen_token', currentToken);
                    localStorage.setItem('cvgen_user', JSON.stringify(data.data.user));
                    
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Login realizado com sucesso!</div>
                        <div><strong>Usu√°rio:</strong> ${data.data.user.name}</div>
                        <div><strong>Plano:</strong> ${data.data.user.plan}</div>
                        <div><strong>Token:</strong> ${currentToken.substring(0, 50)}...</div>
                    `;
                    log('‚úÖ Login realizado com sucesso', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro no login: ${data.message}</div>`;
                    log(`‚ùå Erro no login: ${data.message}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
                log(`‚ùå Erro no login: ${error.message}`, 'error');
            }
        }

        // 3. Verificar token
        function checkToken() {
            const resultDiv = document.getElementById('tokenResult');
            const token = localStorage.getItem('cvgen_token');
            const user = localStorage.getItem('cvgen_user');

            if (token && user) {
                const userData = JSON.parse(user);
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Token encontrado no localStorage</div>
                    <div><strong>Usu√°rio:</strong> ${userData.name}</div>
                    <div><strong>Email:</strong> ${userData.email}</div>
                    <div><strong>Plano:</strong> ${userData.plan}</div>
                    <div><strong>Token:</strong> ${token.substring(0, 50)}...</div>
                    <pre>${token}</pre>
                `;
                log('‚úÖ Token v√°lido encontrado', 'success');
                currentToken = token;
            } else {
                resultDiv.innerHTML = `<div class="error">‚ùå Nenhum token encontrado no localStorage</div>`;
                log('‚ùå Token n√£o encontrado', 'error');
            }
        }

        // 4. Testar cria√ß√£o de CV
        async function testCreateCV() {
            const resultDiv = document.getElementById('cvResult');
            
            if (!currentToken) {
                currentToken = localStorage.getItem('cvgen_token');
            }

            if (!currentToken) {
                resultDiv.innerHTML = `<div class="error">‚ùå Fa√ßa login primeiro!</div>`;
                return;
            }

            try {
                log('Carregando templates...');
                // Primeiro, carregar templates
                const templatesResponse = await fetch(`${API_URL}/templates`);
                const templatesData = await templatesResponse.json();
                
                if (templatesData.status !== 'sucesso') {
                    throw new Error('Erro ao carregar templates');
                }

                const template = templatesData.data.templates[0];
                log(`Template selecionado: ${template.name}`);

                // Dados do CV de teste
                const cvData = {
                    templateId: template.id,
                    nome: 'Admin Debug',
                    email: 'admin@debug.com',
                    telefone: '(11) 99999-9999',
                    resumo: 'Teste de cria√ß√£o de CV via debug',
                    experiencias: [
                        {
                            empresa: 'Debug Corp',
                            cargo: 'Testador',
                            periodo: '2024 - Atual',
                            descricao: 'Testando funcionalidades do sistema'
                        }
                    ],
                    educacao: [
                        {
                            instituicao: 'Universidade Debug',
                            curso: 'Ci√™ncia da Computa√ß√£o',
                            periodo: '2020 - 2024'
                        }
                    ],
                    habilidades: ['Debug', 'Testing', 'JavaScript']
                };

                log('Criando CV...');
                const response = await fetch(`${API_URL}/cv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(cvData)
                });

                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div><strong>Status HTTP:</strong> ${response.status}</div>
                    <div><strong>Resposta:</strong></div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

                if (response.status === 201 && data.status === 'sucesso') {
                    log('‚úÖ CV criado com sucesso!', 'success');
                } else {
                    log(`‚ùå Erro ao criar CV: ${data.message}`, 'error');
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                log(`‚ùå Erro ao criar CV: ${error.message}`, 'error');
            }
        }

        // Auto-executar teste de conex√£o
        window.onload = function() {
            log('üîß Debug Frontend iniciado');
            testConnection();
            checkToken();
        };
    </script>
</body>
</html>